resources:
- repo: self

variables:
  ArtifactsDirectoryName: 'artifacts'
  BuildConfiguration: 'Debug'
  BuildPlatform: 'Any CPU'
  DotNet3Version: '3.x'
  DotNet6Version: '6.x'
  ContinuousIntegrationBuild: 'true'
  MSBuildArguments: '"/Property:Platform=$(BuildPlatform);Configuration=$(BuildConfiguration)" "/BinaryLogger:$(Build.SourcesDirectory)\$(ArtifactsDirectoryName)\msbuild.binlog"'
  CommonTestArguments: '/noautorsp --no-restore --no-build --configuration:$(BuildConfiguration)'
  DOTNET_CLI_TELEMETRY_OPTOUT: 'true'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 'true'
  DOTNET_MULTILEVEL_LOOKUP: 'false'

trigger:
  batch: 'true'
  branches:
    include:
    - 'main'
    - 'refs/tags/*'
  paths:
    exclude:
    - '*.md'
pr:
  branches:
    include:
    - 'main'
  paths:
    exclude:
    - '*.md'

jobs:
- job: BuildAndTest
  displayName: 'Build and Test'
  pool:
    vmImage: windows-latest
  steps:
  - script: 'echo ##vso[task.setvariable variable=BuildConfiguration;]Release'
    displayName: 'Set BuildConfiguration to Release for tagged commits'
    condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/v'))

  - task: UseDotNet@2
    displayName: 'Install .NET Core $(DotNet3Version)'
    inputs:
      version: '$(DotNet3Version)'

  - task: UseDotNet@2
    displayName: 'Install .NET $(DotNet6Version)'
    inputs:
      version: '$(DotNet6Version)'

  - task: MSBuild@1
    displayName: 'Build Solution'
    inputs:
      platform: '$(BuildPlatform)'
      configuration: '$(BuildConfiguration)'
      msbuildArguments: '$(MSBuildArguments)'

  - task: DotNetCoreCLI@2
    displayName: 'Run Unit Tests (.NET Framework)'
    inputs:
      command: 'test'
      arguments: '$(CommonTestArguments) --framework net472 --collect:"XPlat Code Coverage" --logger trx --results-directory TestResults_net472'
      publishTestResults: false
    condition: succeededOrFailed()

  - task: PublishTestResults@2
    displayName: 'Publish Unit Test Results (.NET Framework)'
    inputs:
      testResultsFormat: 'VSTest'
      testResultsFiles: '*.trx' 
      searchFolder: 'TestResults_net472'
      testRunTitle: '.NET Framework v4.7.2'
      buildPlatform: $(BuildPlatform)
      buildConfiguration: $(BuildConfiguration)

  - task: PublishCodeCoverageResults@1
    displayName: 'Publish Code Coverage Results (.NET Framework)'
    inputs:
      codeCoverageTool: 'Cobertura'
      summaryFileLocation: 'TestResults_net472\VssAdministrator*\**\coverage.cobertura.xml'
    condition: succeededOrFailed()

  - task: DotNetCoreCLI@2
    displayName: 'Run Unit Tests (.NET Core 3.0)'
    inputs:
      command: 'test'
      arguments: '$(CommonTestArguments) --framework netcoreapp3.1'
    condition: succeededOrFailed()

  - task: DotNetCoreCLI@2
    displayName: 'Run Unit Tests (.NET 6.0)'
    inputs:
      command: 'test'
      arguments: '$(CommonTestArguments) --framework net6.0'
    condition: succeededOrFailed()

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifacts'
    inputs:
      PathtoPublish: '$(ArtifactsDirectoryName)'
      ArtifactName: $(ArtifactsDirectoryName)
    condition: always()
